<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta name="generator" content="Hugo 0.80.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>Plugin Development Guide | Apache SkyWalking</title><meta property="og:title" content="Plugin Development Guide" />
<meta property="og:description" content="Plugin Development Guide This document describe how to understand, develop and contribute plugin.
There are 2 kinds of plugin
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Guage, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/main/v8.4.0/en/guides/java-plugin-development-guide/" />
<meta property="article:published_time" content="2021-06-10T08:35:13+00:00" />
<meta property="article:modified_time" content="2021-06-10T08:35:13+00:00" />
<meta itemprop="name" content="Plugin Development Guide">
<meta itemprop="description" content="Plugin Development Guide This document describe how to understand, develop and contribute plugin.
There are 2 kinds of plugin
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Guage, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too.">
<meta itemprop="datePublished" content="2021-06-10T08:35:13+00:00" />
<meta itemprop="dateModified" content="2021-06-10T08:35:13+00:00" />
<meta itemprop="wordCount" content="2707">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Plugin Development Guide"/>
<meta name="twitter:description" content="Plugin Development Guide This document describe how to understand, develop and contribute plugin.
There are 2 kinds of plugin
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Guage, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too."/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-178891182-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<link rel="preload" href="/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">



<link rel="preload" href="/scss/main.min.183547de3e7337ab8639ed4b1e14334ce5038fdec7dd30707617ff0837722518.css" as="style">
<link href="/scss/main.min.183547de3e7337ab8639ed4b1e14334ce5038fdec7dd30707617ff0837722518.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />

<script src="/js/jquery-3.6.0.min.js"></script>





    <title>Plugin Development Guide | Apache SkyWalking</title>
  </head>
  <body class="td-page  project-doc">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
    <div class="sidebar-button"><svg width="40" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="126" height="30" src="/images/logo.png" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll ml-md-auto" id="navigation">
        <ul class="navbar-nav mt-lg-0">
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Documentations</span></a>
			</li>
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
              
            
            <li class="nav-item mr-3 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/zh" ><span>中文博客</span></a>
			</li>
              
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Links
              </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                </div>
            </li>
             
            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
<input id="algolia-search-input" type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">

      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 d-print-none td-sidebar">




                    
                    <h5>Documentation: 
                    <select class="version-select">
                    
                    
                    <option ZgotmplZ value="latest">latest</option>
                    
                    
                    <option ZgotmplZ value="v8.6.0">v8.6.0</option>
                    
                    
                    <option ZgotmplZ value="v8.5.0">v8.5.0</option>
                    
                    
                    <option selected value="v8.4.0">v8.4.0</option>
                    
                    
                    <option ZgotmplZ value="v8.3.0">v8.3.0</option>
                    
                    
                    <option ZgotmplZ value="v8.2.0">v8.2.0</option>
                    
                    </select>
                    </h5>
                    
                    
<ul class="sidebar-menu">
    

    <li>
        
            <a href="/docs/main/v8.4.0/readme">Welcome</a>
        
    </li>

    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/readme">Concepts and Designs<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        

            
            <a href="#">What is SkyWalking?<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/overview">Overview and Core concepts</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/project-goals">Project Goals</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Probe<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/probe-introduction">Introduction</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/service-agent">Service auto instrument agent</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/manual-sdk">Manual instrument SDK</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/service-mesh-probe">Service Mesh probe</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Backend<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/backend-overview">Overview</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/oal">Observability Analysis Language</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/protocols/readme#query-protocol">Query in OAP</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">UI<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/concepts-and-designs/ui-overview">Overview</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/setup/readme">Setup<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        

            
            <a href="#">Language agents in Service<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/readme#language-agents-in-service">Agents</a>
        
    </li>

    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme">Java agent<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/supported-list">Supported middleware, framework and library</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#table-of-agent-configuration-properties">Agent Configuration Properties</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#optional-plugins">Optional plugins</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#bootstrap-class-plugins">Bootstrap/JVM class plugin</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#advanced-reporters">Advanced reporters</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#plugin-development-guide">Plugin development guide</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme#test">Agent plugin tests and performance tests</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/readme#language-agents-in-service">Other language agents</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Service Mesh<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/istio/readme">Observe Istio Control Plane</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/envoy/als_setting">Observe Service Mesh</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Proxy<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        

            
            <a href="#">Envoy Proxy<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/envoy/metrics_service_setting">Send Envoy metrics to SkyWalking with / without Istio</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-ui-setup">Backend, UI and CLI setup document<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-setup">Backend setup document<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/configuration-vocabulary">Configuration Vocabulary</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-setting-override">Overriding settings</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-ip-port">IP and port setting</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-init-mode">Backend init mode startup</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-cluster">Cluster management</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-k8s">Deploy in kubernetes</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-storage">Choose storage</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-receivers">Set receivers</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-fetcher">Open fetchers</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/trace-sampling">Trace sampling</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/slow-db-statement">Slow DB statement threshold</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/guides/backend-oal-scripts">OAL scripts</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-alarm">Alarm</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/advanced-deployment">Advanced deployment options</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/metrics-exporter">Metrics exporter</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/ttl">Time To Live (TTL)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/dynamic-config">Dynamic Configuration</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/uninstrumented-gateways">Uninstrumented Gateways</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/apdex-threshold">Apdex threshold</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/service-auto-grouping">Service Grouping</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/endpoint-grouping-rules">Group Parameterized Endpoints</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-receivers#opentelemetry-receiver">OpenTelemetry Metrics Analysis</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/backend-meter">Meter Analysis</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/spring-sleuth-setup">Spring Sleuth Metrics Analysis</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/setup/backend/ui-setup">UI setup document</a>
        
    </li>

    

    <li>
        
            <a href="https://github.com/apache/skywalking-cli">CLI setup document</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/ui/readme">UI Introduction</a>
        
    </li>

    

    <li>
        

            
            <a href="/docs/main/v8.4.0/en/guides/readme">Contributing Guides<i class="fa fa-angle-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu" >
    

    <li>
        
            <a href="/docs/main/v8.4.0/en/guides/readme#contact-us">Contact us</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/guides/asf/committer">Process to become official Apache SkyWalking Committer</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/guides/how-to-build">Compiling Guide</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/guides/java-plugin-development-guide">Agent plugin development guide</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/protocols/readme">Protocols</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v8.4.0/en/faq/readme">FAQs</a>
        
    </li>

    

</ul>
<script src="/js/sidebar-menu.js"></script>
<script>
  (function (){
    $.sidebarMenu($('.sidebar-menu'))
    var path = window.location.pathname;
    var hash = window.location.hash;
    var $a = $('.sidebar-menu a')
    $a.each(function (e){
      if($(this).attr('href')+'/' === path || $(this).attr('href').replace('#','/#') === path+hash){
        $(this).parents('li').addClass('active').show()
      }
    })
    $a.on('click',function (){
      var url = $(this).attr('href')
      if(url!=='#'){
        window.location.href = url
      }
    })
  })()
</script>
                    <div class="commit-id">Commit Id: 0bdb386</div>
                  





</div>
            <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
                <i class="fa fa-bars doc-menu-button"></i>
                
<div class="td-content">











	<h1 id="plugin-development-guide">Plugin Development Guide</h1>
<p>This document describe how to understand, develop and contribute plugin.</p>
<p>There are 2 kinds of plugin</p>
<ol>
<li><a href="#tracing-plugin">Tracing plugin</a>. Follow the distributed tracing concept to collect spans with tags and logs.</li>
<li><a href="#meter-plugin">Meter plugin</a>. Collect numeric metrics in Counter, Guage, and Histogram formats.</li>
</ol>
<p>We also provide the <a href="#plugin-test-tool">plugin test tool</a> to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too.</p>
<h1 id="tracing-plugin">Tracing plugin</h1>
<h2 id="concepts">Concepts</h2>
<h3 id="span">Span</h3>
<p>Span is an important and common concept in distributed tracing system. Learn <strong>Span</strong> from
<a href="https://research.google.com/pubs/pub36356.html">Google Dapper Paper</a>  and
<a href="http://opentracing.io">OpenTracing</a></p>
<p>SkyWalking supports OpenTracing and OpenTracing-Java API from 2017. Our Span concepts are similar with the paper and OpenTracing.
Also we extend the Span.</p>
<p>There are three types of Span</p>
<p>1.1 EntrySpan
EntrySpan represents a service provider, also the endpoint of server side. As an APM system, we are targeting the
application servers. So almost all the services and MQ-consumer are EntrySpan(s).</p>
<p>1.2 LocalSpan
LocalSpan represents a normal Java method, which does not relate to remote service, neither a MQ producer/consumer
nor a service(e.g. HTTP service) provider/consumer.</p>
<p>1.3 ExitSpan
ExitSpan represents a client of service or MQ-producer, as named as <code>LeafSpan</code> at early age of SkyWalking.
e.g. accessing DB by JDBC, reading Redis/Memcached are cataloged an ExitSpan.</p>
<h3 id="contextcarrier">ContextCarrier</h3>
<p>In order to implement distributed tracing, the trace across process need to be bind, and the context should propagate
across the process. That is ContextCarrier&rsquo;s duty.</p>
<p>Here are the steps about how to use <strong>ContextCarrier</strong> in a <code>A-&gt;B</code> distributed call.</p>
<ol>
<li>Create a new and empty <code>ContextCarrier</code> at client side.</li>
<li>Create an ExitSpan by <code>ContextManager#createExitSpan</code> or use <code>ContextManager#inject</code> to init the <code>ContextCarrier</code>.</li>
<li>Put all items of <code>ContextCarrier</code> into heads(e.g. HTTP HEAD), attachments(e.g. Dubbo RPC framework) or messages(e.g. Kafka)</li>
<li>The <code>ContextCarrier</code> propagates to server side by the service call.</li>
<li>At server side, get all items from heads, attachments or messages.</li>
<li>Create an EntrySpan by <code>ContextManager#createEntrySpan</code> or use <code>ContextManager#extract</code> to bind the client and server.</li>
</ol>
<p>Let&rsquo;s demonstrate the steps by Apache HTTPComponent client plugin and Tomcat 7 server plugin</p>
<ol>
<li>Client side steps by Apache HTTPComponent client plugin</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">            span <span style="color:#000;font-weight:bold">=</span> ContextManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createExitSpan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/span/operation/name&#34;</span><span style="color:#000;font-weight:bold">,</span> contextCarrier<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;ip:port&#34;</span><span style="color:#000;font-weight:bold">);</span>
            CarrierItem next <span style="color:#000;font-weight:bold">=</span> contextCarrier<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">items</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNext</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                next <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
                httpRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadKey</span><span style="color:#000;font-weight:bold">(),</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadValue</span><span style="color:#000;font-weight:bold">());</span>
            <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ol start="2">
<li>Server side steps by Tomcat 7 server plugin</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">            ContextCarrier contextCarrier <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ContextCarrier<span style="color:#000;font-weight:bold">();</span>
            CarrierItem next <span style="color:#000;font-weight:bold">=</span> contextCarrier<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">items</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNext</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                next <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
                next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeadValue</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadKey</span><span style="color:#000;font-weight:bold">()));</span>
            <span style="color:#000;font-weight:bold">}</span>

            span <span style="color:#000;font-weight:bold">=</span> ContextManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createEntrySpan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a61717;background-color:#e3d2d2">“</span><span style="color:#000;font-weight:bold">/</span>span<span style="color:#000;font-weight:bold">/</span>operation<span style="color:#000;font-weight:bold">/</span>name<span style="color:#a61717;background-color:#e3d2d2">”</span><span style="color:#000;font-weight:bold">,</span> contextCarrier<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="contextsnapshot">ContextSnapshot</h3>
<p>Besides across process, across thread but in a process need to be supported, because async process(In-memory MQ)
and batch process are common in Java. Across process and across thread are similar, because they are both about propagating
context. The only difference is that, don&rsquo;t need to serialize for across thread.</p>
<p>Here are the three steps about across thread propagation:</p>
<ol>
<li>Use <code>ContextManager#capture</code> to get the ContextSnapshot object.</li>
<li>Let the sub-thread access the ContextSnapshot by any way, through method arguments or carried by an existed arguments</li>
<li>Use <code>ContextManager#continued</code> in sub-thread.</li>
</ol>
<h2 id="core-apis">Core APIs</h2>
<h3 id="contextmanager">ContextManager</h3>
<p>ContextManager provides all major and primary APIs.</p>
<ol>
<li>Create EntrySpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createEntrySpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">,</span> ContextCarrier carrier<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create EntrySpan by operation name(e.g. service name, uri) and <strong>ContextCarrier</strong>.</p>
<ol start="2">
<li>Create LocalSpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createLocalSpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create LocalSpan by operation name(e.g. full method signature)</p>
<ol start="3">
<li>Create ExitSpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createExitSpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">,</span> ContextCarrier carrier<span style="color:#000;font-weight:bold">,</span> String remotePeer<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create ExitSpan by operation name(e.g. service name, uri) and new <strong>ContextCarrier</strong> and peer address
(e.g. ip+port, hostname+port)</p>
<h3 id="abstractspan">AbstractSpan</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set the component id, which defines in {@link ComponentsDefine}
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param component
</span><span style="color:#998;font-style:italic">     * @return the span for chaining.
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">setComponent</span><span style="color:#000;font-weight:bold">(</span>Component component<span style="color:#000;font-weight:bold">);</span>

    AbstractSpan <span style="color:#900;font-weight:bold">setLayer</span><span style="color:#000;font-weight:bold">(</span>SpanLayer layer<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set a key:value tag on the Span.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return this Span instance, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">tag</span><span style="color:#000;font-weight:bold">(</span>String key<span style="color:#000;font-weight:bold">,</span> String value<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Record an exception event of the current walltime timestamp.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param t any subclass of {@link Throwable}, which occurs in this span.
</span><span style="color:#998;font-style:italic">     * @return the Span, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">log</span><span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">);</span>

    AbstractSpan <span style="color:#900;font-weight:bold">errorOccurred</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Record an event at a specific timestamp.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param timestamp The explicit timestamp for the log record.
</span><span style="color:#998;font-style:italic">     * @param event the events
</span><span style="color:#998;font-style:italic">     * @return the Span, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span> timestamp<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">?&gt;</span> event<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Sets the string name for the logical operation this span represents.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return this Span instance, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">setOperationName</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Besides setting operation name, tags and logs, two attributes should be set, which are component and layer,
especially for EntrySpan and ExitSpan</p>
<p>SpanLayer is the catalog of span. Here are 5 values:</p>
<ol>
<li>UNKNOWN (default)</li>
<li>DB</li>
<li>RPC_FRAMEWORK, for a RPC framework, not an ordinary HTTP</li>
<li>HTTP</li>
<li>MQ</li>
</ol>
<p>Component IDs are defined and reserved by SkyWalking project.
For component name/ID extension, please follow <a href="../component-library-settings">Component library definition and extension</a> document.</p>
<h3 id="special-span-tags">Special Span Tags</h3>
<p>All tags are available in the trace view, meanwhile,
in the OAP backend analysis, some special tag or tag combination could provide other advanced features.</p>
<h4 id="tag-key-status_code">Tag key <code>status_code</code></h4>
<p>The value should be an integer. The response code of OAL entities is according to this.</p>
<h4 id="tag-key-dbstatement-and-dbtype">Tag key <code>db.statement</code> and <code>db.type</code>.</h4>
<p>The value of <code>db.statement</code> should be a String, representing the Database statement, such as SQL, or <code>[No statement]/</code>+span#operationName if value is empty.
When exit span has this tag, OAP samples the slow statements based on <code>agent-analyzer/default/maxSlowSQLLength</code>.
The threshold of slow statement is defined by following <a href="../../setup/backend/slow-db-statement"><code>agent-analyzer/default/slowDBAccessThreshold</code></a></p>
<h4 id="extension-logic-endpoint-tag-key-x-le">Extension logic endpoint. Tag key <code>x-le</code></h4>
<p>Logic endpoint is a concept, which doesn&rsquo;t represent a real RPC call, but requires the statistic.
The value of <code>x-le</code> should be JSON format, with two options.</p>
<ol>
<li>Define a separated logic endpoint. Provide its own endpoint name, latency and status. Suitable for entry and local span.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;GraphQL-service&#34;</span>,
  <span style="color:#000080">&#34;latency&#34;</span>: <span style="color:#099">100</span>,
  <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#000;font-weight:bold">true</span>
}
</code></pre></div><ol start="2">
<li>Declare the current local span representing a logic endpoint.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;logic-span&#34;</span>: <span style="color:#000;font-weight:bold">true</span>
}
</code></pre></div><h3 id="advanced-apis">Advanced APIs</h3>
<h4 id="async-span-apis">Async Span APIs</h4>
<p>There is a set of advanced APIs in Span, which work specific for async scenario. When tags, logs, attributes(including end time) of the span
needs to set in another thread, you should use these APIs.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * The span finish at current tracing context, but the current span is still alive, until {@link #asyncFinish}
</span><span style="color:#998;font-style:italic">     * called.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * This method must be called&lt;br/&gt;
</span><span style="color:#998;font-style:italic">     * 1. In original thread(tracing context).
</span><span style="color:#998;font-style:italic">     * 2. Current span is active span.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * During alive, tags, logs and attributes of the span could be changed, in any thread.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return the current span
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">prepareForAsync</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Notify the span, it could be finished.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return the current span
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">asyncFinish</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><ol>
<li>Call <code>#prepareForAsync</code> in original context.</li>
<li>Do <code>ContextManager#stopSpan</code> in original context when your job in current thread is done.</li>
<li>Propagate the span to any other thread.</li>
<li>After all set, call <code>#asyncFinish</code> in any thread.</li>
<li>Tracing context will be finished and report to backend when all spans&rsquo;s <code>#prepareForAsync</code> finished(Judged by count of API execution).</li>
</ol>
<h2 id="develop-a-plugin">Develop a plugin</h2>
<h3 id="abstract">Abstract</h3>
<p>The basic method to trace is intercepting a Java method, by using byte code manipulation tech and AOP concept.
SkyWalking boxed the byte code manipulation tech and tracing context propagation,
so you just need to define the intercept point(a.k.a. aspect pointcut in Spring)</p>
<h3 id="intercept">Intercept</h3>
<p>SkyWalking provide two common defines to intercept Contructor, instance method and class method.</p>
<ul>
<li>Extend <code>ClassInstanceMethodsEnhancePluginDefine</code> defines <code>Contructor</code> intercept points and <code>instance method</code> intercept points.</li>
<li>Extend <code>ClassStaticMethodsEnhancePluginDefine</code> defines <code>class method</code> intercept points.</li>
</ul>
<p>Of course, you can extend <code>ClassEnhancePluginDefine</code> to set all intercept points. But it is unusual.</p>
<h3 id="implement-plugin">Implement plugin</h3>
<p>I will demonstrate about how to implement a plugin by extending <code>ClassInstanceMethodsEnhancePluginDefine</code></p>
<ol>
<li>Define the target class name</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#000;font-weight:bold">abstract</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClass</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>ClassMatch represents how to match the target classes, there are 4 ways:</p>
<ul>
<li>byName, through the full class name(package name + <code>.</code> + class name)</li>
<li>byClassAnnotationMatch, through the class existed certain annotations.</li>
<li>byMethodAnnotationMatch, through the class&rsquo;s method existed certain annotations.</li>
<li>byHierarchyMatch, through the class&rsquo;s parent classes or interfaces</li>
</ul>
<p><strong>Attentions</strong>:</p>
<ul>
<li>Never use <code>ThirdPartyClass.class</code> in the instrumentation definitions, such as <code>takesArguments(ThirdPartyClass.class)</code>, or <code>byName(ThirdPartyClass.class.getName())</code>, because of the fact that <code>ThirdPartyClass</code> dose not necessarily exist in the target application and this will break the agent; we have <code>import</code> checks to help on checking this in CI, but it doesn&rsquo;t cover all scenarios of this limitation, so never try to work around this limitation by something like using full-qualified-class-name (FQCN), i.e. <code>takesArguments(full.qualified.ThirdPartyClass.class)</code> and <code>byName(full.qualified.ThirdPartyClass.class.getName())</code> will pass the CI check, but are still invalid in the agent codes, <strong>Use Full Qualified Class Name String Literature Instead</strong>.</li>
<li>Even you are perfectly sure that the class to be intercepted exists in the target application (such as JDK classes), still, don&rsquo;t use <code>*.class.getName()</code> to get the class String name. Recommend you to use literal String. This is for
avoiding ClassLoader issues.</li>
<li><code>by*AnnotationMatch</code> doesn&rsquo;t support the inherited annotations.</li>
<li>Don&rsquo;t recommend to use <code>byHierarchyMatch</code>, unless it is really necessary. Because using it may trigger intercepting
many unexcepted methods, which causes performance issues and concerns.</li>
</ul>
<p>Example：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClassName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> byName<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;org.apache.catalina.core.StandardEngineValve&#34;</span><span style="color:#000;font-weight:bold">);</span>		
<span style="color:#000;font-weight:bold">}</span>		      

</code></pre></div><ol start="2">
<li>Define an instance method intercept point</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getInstanceMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">InstanceMethodsInterceptPoint</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * class instance methods matcher.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return methods matcher
</span><span style="color:#998;font-style:italic">     */</span>
    ElementMatcher<span style="color:#000;font-weight:bold">&lt;</span>MethodDescription<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getMethodsMatcher</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * @return represents a class name, the class instance must instanceof InstanceMethodsAroundInterceptor.
</span><span style="color:#998;font-style:italic">     */</span>
    String <span style="color:#900;font-weight:bold">getMethodsInterceptor</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isOverrideArgs</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Also use <code>Matcher</code> to set the target methods. Return <strong>true</strong> in <code>isOverrideArgs</code>, if you want to change the argument
ref in interceptor.</p>
<p>The following sections will tell you how to implement the interceptor.</p>
<ol start="3">
<li>Add plugin define into skywalking-plugin.def file</li>
</ol>
<pre><code class="language-properties" data-lang="properties">tomcat-7.x/8.x=TomcatInstrumentation
</code></pre><ol start="4">
<li>
<p>Set up <code>witnessClasses</code> and/or <code>witnessMethods</code> if the instrumentation should be activated in specific versions.</p>
<p>Example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// The plugin is activated only when the foo.Bar class exists.
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> String<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">witnessClasses</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> String<span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#d14">&#34;foo.Bar&#34;</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
   
<span style="color:#998;font-style:italic">// The plugin is activated only when the foo.Bar#hello method exists.
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> List<span style="color:#000;font-weight:bold">&lt;</span>WitnessMethod<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">witnessMethods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>WitnessMethod<span style="color:#000;font-weight:bold">&gt;</span> witnessMethodList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  WitnessMethod witnessMethod <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> WitnessMethod<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;foo.Bar&#34;</span><span style="color:#000;font-weight:bold">,</span> ElementMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">named</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">));</span>
  witnessMethodList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>witnessMethod<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> witnessMethodList<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>For more example, see <a href="..//apm-sniffer/apm-agent-core/src/test/java/org/apache/skywalking/apm/agent/core/plugin/witness/witnesstest.java">WitnessTest.java</a></p>
</li>
</ol>
<h3 id="implement-an-interceptor">Implement an interceptor</h3>
<p>As an interceptor for an instance method, the interceptor implements
<code>org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic"> * A interceptor, which intercept method&#39;s invocation. The target methods will be defined in {@link
</span><span style="color:#998;font-style:italic"> * ClassEnhancePluginDefine}&#39;s subclass, most likely in {@link ClassInstanceMethodsEnhancePluginDefine}
</span><span style="color:#998;font-style:italic">*/</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">InstanceMethodsAroundInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called before target method invocation.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param result change this result, if you want to truncate the method.
</span><span style="color:#998;font-style:italic">     * @throws Throwable
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">beforeMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        MethodInterceptResult result<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called after target method invocation. Even method&#39;s invocation triggers an exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param ret the method&#39;s original return value.
</span><span style="color:#998;font-style:italic">     * @return the method&#39;s actual return value.
</span><span style="color:#998;font-style:italic">     * @throws Throwable
</span><span style="color:#998;font-style:italic">     */</span>
    Object <span style="color:#900;font-weight:bold">afterMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        Object ret<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called when occur exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param t the exception occur.
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleMethodException</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        Throwable t<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Use the core APIs in before, after and exception handle stages.</p>
<h3 id="do-bootstrap-class-instrumentation">Do bootstrap class instrumentation.</h3>
<p>SkyWalking has packaged the bootstrap instrumentation in the agent core. It is easy to open by declaring it in the Instrumentation definition.</p>
<p>Override the <code>public boolean isBootstrapInstrumentation()</code> and return <strong>true</strong>. Such as</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">URLInstrumentation</span> <span style="color:#000;font-weight:bold">extends</span> ClassEnhancePluginDefine <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String CLASS_NAME <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;java.net.URL&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">protected</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClass</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> byName<span style="color:#000;font-weight:bold">(</span>CLASS_NAME<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getConstructorsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">new</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> ElementMatcher<span style="color:#000;font-weight:bold">&lt;</span>MethodDescription<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getConstructorMatcher</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">return</span> any<span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">}</span>

                <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getConstructorInterceptor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;org.apache.skywalking.apm.plugin.jre.httpurlconnection.Interceptor2&#34;</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getInstanceMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> StaticMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getStaticMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> StaticMethodsInterceptPoint<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isBootstrapInstrumentation</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p><strong>NOTICE</strong>, doing bootstrap instrumentation should only happen in necessary, but mostly it effect the JRE core(rt.jar),
and could make very unexpected result or side effect.</p>
<h3 id="provide-customization-config-for-the-plugin">Provide Customization Config for the Plugin</h3>
<p>The config could provide different behaviours based on the configurations. SkyWalking plugin mechanism provides the configuration
injection and initialization system in the agent core.</p>
<p>Every plugin could declare one or more classes to represent the config by using <code>@PluginConfig</code> annotation. The agent core
could initialize this class' static field though System environments, System properties, and <code>agent.config</code> static file.</p>
<p>The <code>#root()</code> method in the <code>@PluginConfig</code> annotation requires to declare the root class for the initialization process.
Typically, SkyWalking prefers to use nested inner static classes for the hierarchy of the configuration.
Recommend using <code>Plugin</code>/<code>plugin-name</code>/<code>config-key</code> as the nested classes structure of the Config class.</p>
<p>NOTE, because of the Java ClassLoader mechanism, the <code>@PluginConfig</code> annotation should be added on the real class used in the interceptor codes.</p>
<p>Such as, in the following example, <code>@PluginConfig(root = SpringMVCPluginConfig.class)</code> represents the initialization should
start with using <code>SpringMVCPluginConfig</code> as the root. Then the config key of the attribute <code>USE_QUALIFIED_NAME_AS_ENDPOINT_NAME</code>,
should be <code>plugin.springmvc.use_qualified_name_as_endpoint_name</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringMVCPluginConfig</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Plugin</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// NOTE, if move this annotation on the `Plugin` or `SpringMVCPluginConfig` class, it no longer has any effect. 
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#3c5d5d;font-weight:bold">@PluginConfig</span><span style="color:#000;font-weight:bold">(</span>root <span style="color:#000;font-weight:bold">=</span> SpringMVCPluginConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringMVC</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * If true, the fully qualified method name will be used as the endpoint name instead of the request URL,
</span><span style="color:#998;font-style:italic">             * default is false.
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> USE_QUALIFIED_NAME_AS_ENDPOINT_NAME <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>

            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * This config item controls that whether the SpringMVC plugin should collect the parameters of the
</span><span style="color:#998;font-style:italic">             * request.
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> COLLECT_HTTP_PARAMS <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#3c5d5d;font-weight:bold">@PluginConfig</span><span style="color:#000;font-weight:bold">(</span>root <span style="color:#000;font-weight:bold">=</span> SpringMVCPluginConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Http</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * When either {@link Plugin.SpringMVC#COLLECT_HTTP_PARAMS} is enabled, how many characters to keep and send
</span><span style="color:#998;font-style:italic">             * to the OAP backend, use negative values to keep and send the complete parameters, NB. this config item is
</span><span style="color:#998;font-style:italic">             * added for the sake of performance
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">int</span> HTTP_PARAMS_LENGTH_THRESHOLD <span style="color:#000;font-weight:bold">=</span> 1024<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h1 id="meter-plugin">Meter Plugin</h1>
<p>Java agent plugin could use meter APIs to collect the metrics for backend analysis.</p>
<ul>
<li><code>Counter</code> API represents a single monotonically increasing counter, automatic collect data and report to backend.</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

Counter counter <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">counter</span><span style="color:#000;font-weight:bold">(</span>meterName<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">mode</span><span style="color:#000;font-weight:bold">(</span>Counter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Mode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INCREMENT</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
counter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>1d<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ol>
<li><code>MeterFactory.counter</code> Create a new counter builder with the meter name.</li>
<li><code>Counter.Builder.tag(String key, String value)</code> Mark a tag key/value pair.</li>
<li><code>Counter.Builder.mode(Counter.Mode mode)</code> Change the counter mode, <code>RATE</code> mode means reporting rate to the backend.</li>
<li><code>Counter.Builder.build()</code> Build a new <code>Counter</code> which is collected and reported to the backend.</li>
<li><code>Counter.increment(double count)</code> Increment count to the <code>Counter</code>, It could be a positive value.</li>
</ol>
<ul>
<li><code>Gauge</code> API represents a single numerical value.</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

ThreadPoolExecutor threadPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">...;</span>
Gauge gauge <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">gauge</span><span style="color:#000;font-weight:bold">(</span>meterName<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-&gt;</span> threadPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getActiveCount</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><ol>
<li><code>MeterFactory.gauge(String name, Supplier&lt;Double&gt; getter)</code> Create a new gauge builder with the meter name and supplier function, this function need to return a <code>double</code> value.</li>
<li><code>Gauge.Builder.tag(String key, String value)</code> Mark a tag key/value pair.</li>
<li><code>Gauge.Builder.build()</code> Build a new <code>Gauge</code> which is collected and reported to the backend.</li>
</ol>
<ul>
<li><code>Histogram</code> API represents a summary sample observations with customize buckets.</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

Histogram histogram <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">histogram</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">steps</span><span style="color:#000;font-weight:bold">(</span>Arrays<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">asList</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> 5<span style="color:#000;font-weight:bold">,</span> 10<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">minValue</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
histogram<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addValue</span><span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ol>
<li><code>MeterFactory.histogram(String name)</code> Create a new histogram builder with the meter name.</li>
<li><code>Histogram.Builder.tag(String key, String value)</code> Mark a tag key/value pair.</li>
<li><code>Histogram.Builder.steps(List&lt;Double&gt; steps)</code> Set up the max values of every histogram buckets.</li>
<li><code>Histogram.Builder.minValue(double value)</code> Set up the minimal value of this histogram, default is <code>0</code>.</li>
<li><code>Histogram.Builder.build()</code> Build a new <code>Histogram</code> which is collected and reported to the backend.</li>
<li><code>Histogram.addValue(double value)</code> Add value into the histogram, automatically analyze what bucket count needs to be increment. rule: count into [step1, step2).</li>
</ol>
<h1 id="plugin-test-tool">Plugin Test Tool</h1>
<p><a href="https://github.com/apache/skywalking-agent-test-tool">Apache SkyWalking Agent Test Tool Suite</a>
a tremendously useful test tools suite in a wide variety of languages of Agent. Includes mock collector and validator.
The mock collector is a SkyWalking receiver, like OAP server.</p>
<p>You could learn how to use this tool to test the plugin in <a href="../plugin-test">this doc</a>. If you want to contribute plugins
to SkyWalking official repo, this is required.</p>
<h1 id="contribute-plugins-into-apache-skywalking-repository">Contribute plugins into Apache SkyWalking repository</h1>
<p>We are welcome everyone to contribute plugins.</p>
<p>Please follow there steps:</p>
<ol>
<li>Submit an issue about which plugins you are going to contribute, including supported version.</li>
<li>Create sub modules under <code>apm-sniffer/apm-sdk-plugin</code> or <code>apm-sniffer/optional-plugins</code>, and the name should include supported library name and versions</li>
<li>Follow this guide to develop. Make sure comments and test cases are provided.</li>
<li>Develop and test.</li>
<li>Provide the automatic test cases. Learn <code>how to write the plugin test case</code> from this <a href="../plugin-test">doc</a></li>
<li>Send the pull request and ask for review.</li>
<li>The plugin committers approve your plugins, plugin CI-with-IT, e2e and plugin tests passed.</li>
<li>The plugin accepted by SkyWalking.</li>
</ol>




</div>


            </main>
          <div id="toc" class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#plugin-development-guide">Plugin Development Guide</a></li>
    <li><a href="#tracing-plugin">Tracing plugin</a>
      <ul>
        <li><a href="#concepts">Concepts</a>
          <ul>
            <li><a href="#span">Span</a></li>
            <li><a href="#contextcarrier">ContextCarrier</a></li>
            <li><a href="#contextsnapshot">ContextSnapshot</a></li>
          </ul>
        </li>
        <li><a href="#core-apis">Core APIs</a>
          <ul>
            <li><a href="#contextmanager">ContextManager</a></li>
            <li><a href="#abstractspan">AbstractSpan</a></li>
            <li><a href="#special-span-tags">Special Span Tags</a></li>
            <li><a href="#advanced-apis">Advanced APIs</a></li>
          </ul>
        </li>
        <li><a href="#develop-a-plugin">Develop a plugin</a>
          <ul>
            <li><a href="#abstract">Abstract</a></li>
            <li><a href="#intercept">Intercept</a></li>
            <li><a href="#implement-plugin">Implement plugin</a></li>
            <li><a href="#implement-an-interceptor">Implement an interceptor</a></li>
            <li><a href="#do-bootstrap-class-instrumentation">Do bootstrap class instrumentation.</a></li>
            <li><a href="#provide-customization-config-for-the-plugin">Provide Customization Config for the Plugin</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#meter-plugin">Meter Plugin</a></li>
    <li><a href="#plugin-test-tool">Plugin Test Tool</a></li>
    <li><a href="#contribute-plugins-into-apache-skywalking-repository">Contribute plugins into Apache SkyWalking repository</a></li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>

        </div>
      </div>

      
<footer class="bg-dark py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-white" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/skywalking">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-white">&copy; 2017 - 2021 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-white   mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    















































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/zh/" class="nav-link">中文博客</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open"><a class="dropdown-title"><span class="title">Links</span> <span
                    class="arrow down"></span></a>
                <ul class="nav-dropdown" style="">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="/js/bootstrap.bundle.min.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>











<script src="/js/main.min.b39e9e0a8b4cdf9f436c5f7899461300ecea2f05f620805ef970b7832857a4cb.js" integrity="sha256-s56eCotM359DbF94mUYTAOzqLwX2IIBe&#43;XC3gyhXpMs=" crossorigin="anonymous"></script>





  </body>
  <script>
    $(function (){
      $('.doc-menu-button').on('click',function (){
        $('.td-sidebar').toggleClass('active')
      })
      $('.version-select').on('change', function (){
        var selectVersion = $(this).val();
        var prefix = '';
        var url = location.href.replace(/(\/docs\/[a-zA-Z\-]+\/)([\w|\.]+)(\/.*)/, function (match, p1, p2, p3){
          prefix = p1 + selectVersion;
          return p1 + selectVersion + p3
        })
        go2SelectVersion(url, prefix)

      })
      function go2SelectVersion(url, prefix){
        $.ajax({
          url: url,
          type: "get",
          success:function(){
            location.href = url;
          },
          statusCode: {
            404:function(){
              location.href = prefix + '/readme/';
            }
          }
        });
      }
    })
  </script>
</html>
